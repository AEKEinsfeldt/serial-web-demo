<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tabletop Game Serial Interface 1.1</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; text-align: center; }
        button { padding: 10px 20px; margin: 5px; font-size: 16px; }
        #output { margin-top: 20px; padding: 10px; border: 1px solid #ccc; height: 200px; overflow-y: scroll; text-align: left; }
    </style>
</head>
<body>
    <h1>Tabletop Game Serial Interface 1.2  </h1>
    <button id="connectButton">Connect to Serial Port</button>
    <button id="sendModuleInfo" disabled>Request Module Info</button>
    <button id="repositionModules" disabled>Reposition Modules</button>
    <button id="disconnectButton" disabled>Disconnect</button>
    <div id="output">Serial Output:<br></div>

    <script>
        let port;
        let reader;
        let writer;
        let keepReading = true;

        const connectButton = document.getElementById('connectButton');
        const sendModuleInfo = document.getElementById('sendModuleInfo');
        const repositionModules = document.getElementById('repositionModules');
        const disconnectButton = document.getElementById('disconnectButton');
        const outputDiv = document.getElementById('output');

        function log(message) {
            outputDiv.innerHTML += message + '<br>';
            outputDiv.scrollTop = outputDiv.scrollHeight;
        }

async function connectSerial() {
    try {
        log('Requesting port...');
        port = await navigator.serial.requestPort();
        log('Port selected, opening...');
        await port.open({ baudRate: 115200, parity: 'none', stopBits: 2 });
        log('Connected to serial port');

        connectButton.disabled = true;
        sendModuleInfo.disabled = false;
        repositionModules.disabled = false;
        disconnectButton.disabled = false;

        const encoder = new TextEncoderStream();
        writer = encoder.writable.getWriter();
        encoder.readable.pipeTo(port.writable);

        const decoder = new TextDecoderStream();
        const inputStream = port.readable.pipeThrough(decoder);
        reader = inputStream.getReader();
        readSerial();
    } catch (error) {
        log('Error connecting: ' + error);
    }
}

        async function readSerial() {
            while (port.readable && keepReading) {
                const { value, done } = await reader.read();
                if (done) {
                    log('Reader closed');
                    break;
                }
                if (value) {
                    parseProtocol(new Uint8Array(value.split('').map(c => c.charCodeAt(0))));
                }
            }
        }

        function calculateChecksum(data) {
            let sum = 0;
            for (let byte of data) sum += byte;
            return (~sum + 1) & 0xFF; // 2's complement
        }

        function parseProtocol(data) {
            if (data[0] !== 0x02 || data.length < 3) return;
            const size = data[1];
            if (data.length !== size + 2) return; // +2 for start and CKS
            const cks = data[size + 1];
            const calcCks = calculateChecksum(data.slice(0, -1));
            if (cks !== calcCks) {
                log('Checksum error');
                return;
            }
            const command = data[2];
            if (command === 0x22) {
                const gameStatus = data[3];
                const modx = data[4];
                const mody = data[5];
                const swrevMaj = data[6];
                const swrevMin = data[7];
                log(`Module Info: Game Status=${gameStatus}, Address=(${modx},${mody}), SW Rev=${swrevMaj}.${swrevMin}`);
            }
        }

        async function sendCommand(tam,command, subCommand = 0, data5 = 0, data6 = 0) {
            const packet = new Uint8Array([0x02, tam, command, 3, subCommand, data5, data6, 0, 0]);
            packet.length = packet.[1] + 1;
            packet[packet.[1]] = calculateChecksum(packet.slice(0, packet[1]));
            await writer.write(String.fromCharCode(...packet.slice(0, packet[1]+1)));
            log(`Sent command 0x${command.toString(16)}`);
        }

        async function disconnectSerial() {
            keepReading = false;
            if (reader) await reader.cancel();
            if (writer) await writer.close();
            if (port) await port.close();
            log('Disconnected');
            connectButton.disabled = false;
            sendModuleInfo.disabled = true;
            repositionModules.disabled = true;
            disconnectButton.disabled = true;
        }

        connectButton.addEventListener('click', connectSerial);
        sendModuleInfo.addEventListener('click', () => sendCommand(7,0x20, 0x03, 254));
        repositionModules.addEventListener('click', () => sendCommand(4,0x12));
        disconnectButton.addEventListener('click', disconnectSerial);
    </script>
</body>
</html>
